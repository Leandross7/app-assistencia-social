<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUAS App - Gestão de Atendimentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Biblioteca de Gráficos Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Biblioteca para exportar para Excel (XLSX) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#16A34A">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .fade-in { animation: fadeInAnimation 0.5s ease-in-out forwards; }
        @keyframes fadeInAnimation { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #16a34a; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-button { transition: all 0.3s ease; }
        .nav-button.active { background-color: #16A34A; color: white; }
        .nav-button:not(.active):hover { background-color: #e5e7eb; }
        /* Estilos para o Modal */
        #edit-modal-backdrop, #forgot-password-modal-backdrop, #referral-modal-backdrop { background-color: rgba(0,0,0,0.5); }
        #edit-modal, #forgot-password-modal, #referral-modal { transition: all 0.3s ease-out; }
        
        /* Estilos para validação de senha */
        .password-requirement { font-size: 0.75rem; margin-top: 0.25rem; }
        .password-requirement.valid { color: #10b981; }
        .password-requirement.invalid { color: #ef4444; }
        
        /* Estilos para histórico de edições */
        .edit-history { background-color: #f8fafc; border-left: 4px solid #3b82f6; padding: 0.75rem; margin-top: 0.5rem; }
        .edit-history-item { font-size: 0.875rem; color: #64748b; margin-bottom: 0.25rem; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Tela de Login e Cadastro -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div class="w-full max-w-md">
            <div class="flex justify-center mb-6">
                 <svg class="h-16 w-16 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0012 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75z" /></svg>
            </div>
            <div id="login-view">
                <form id="login-form" class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Login</h2>
                    <div class="mb-4"><label for="login-email" class="block text-sm font-medium text-gray-600">Email</label><input type="email" id="login-email" required class="mt-1 w-full p-3 bg-gray-50 border rounded-md focus:ring-green-500 focus:border-green-500"></div>
                    <div class="mb-6"><label for="login-password" class="block text-sm font-medium text-gray-600">Senha</label><input type="password" id="login-password" required class="mt-1 w-full p-3 bg-gray-50 border rounded-md focus:ring-green-500 focus:border-green-500"></div>
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors">Entrar</button>
                    <div class="text-center mt-4">
                        <a href="#" id="forgot-password-link" class="text-sm text-green-600 hover:underline">Esqueci minha senha</a>
                    </div>
                    <p id="register-link-container" class="text-center text-sm text-gray-500 mt-4">Não tem uma conta? <a href="#" id="show-register-link" class="text-green-600 hover:underline">Cadastre-se</a></p>
                </form>
            </div>
            <div id="register-view" class="hidden">
                 <form id="register-form" class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Cadastrar Primeiro Administrador</h2>
                    <div class="mb-4"><label for="register-name" class="block text-sm font-medium text-gray-600">Seu Nome</label><input type="text" id="register-name" required class="mt-1 w-full p-3 bg-gray-50 border rounded-md"></div>
                    <div class="mb-4"><label for="register-email" class="block text-sm font-medium text-gray-600">Email</label><input type="email" id="register-email" required class="mt-1 w-full p-3 bg-gray-50 border rounded-md"></div>
                    <div class="mb-4">
                        <label for="register-password" class="block text-sm font-medium text-gray-600">Senha</label>
                        <input type="password" id="register-password" required class="mt-1 w-full p-3 bg-gray-50 border rounded-md">
                        <div id="password-requirements" class="mt-2">
                            <div class="password-requirement invalid" id="req-length">• Mínimo 8 caracteres</div>
                            <div class="password-requirement invalid" id="req-uppercase">• Pelo menos 1 letra maiúscula</div>
                            <div class="password-requirement invalid" id="req-lowercase">• Pelo menos 1 letra minúscula</div>
                            <div class="password-requirement invalid" id="req-number">• Pelo menos 1 número</div>
                            <div class="password-requirement invalid" id="req-special">• Pelo menos 1 caractere especial (!@#$%^&*)</div>
                        </div>
                    </div>
                    <button type="submit" id="register-submit-btn" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors" disabled>Cadastrar</button>
                    <p class="text-center text-sm text-gray-500 mt-4">Já tem uma conta? <a href="#" id="show-login-link" class="text-green-600 hover:underline">Faça Login</a></p>
                </form>
            </div>
             <p id="auth-error" class="text-red-500 text-sm text-center mt-4 h-4"></p>
        </div>
    </div>
    
    <!-- Modal Esqueci Senha -->
    <div id="forgot-password-modal-backdrop" class="fixed inset-0 z-30 hidden items-center justify-center p-4">
        <div id="forgot-password-modal" class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md transform transition-all -translate-y-10 opacity-0">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-700">Recuperar Senha</h2>
                <button id="close-forgot-password-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="forgot-password-form" class="space-y-4">
                <div>
                    <label for="forgot-email" class="block text-sm font-medium text-gray-600">Email</label>
                    <input type="email" id="forgot-email" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border rounded-md">
                </div>
                <div class="flex gap-4">
                    <button type="button" id="cancel-forgot-password-btn" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700">Enviar Link</button>
                </div>
            </form>
            <p id="forgot-password-feedback" class="text-sm text-center mt-4 h-4"></p>
        </div>
    </div>
    
    <!-- Conteúdo Principal do App -->
    <div id="app-container" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-20">
            <div class="container mx-auto px-4 py-3">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3"><svg class="h-10 w-10 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0012 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75z" /></svg><span class="text-xl font-bold text-gray-700">SUAS App</span></div>
                    <nav id="main-nav" class="flex gap-2 bg-gray-200 p-1 rounded-lg"></nav>
                    <div class="flex items-center gap-4">
                        <span class="text-sm text-gray-600">Olá, <span id="user-name-display" class="font-semibold">N/A</span></span>
                        <button id="logout-btn" class="text-sm font-semibold text-red-600 hover:text-red-800 transition-colors">Sair</button>
                    </div>
                </div>
            </div>
        </header>

        <main id="app-content" class="container mx-auto p-4 md:p-8">
            <!-- PÁGINA DE REGISTRO -->
            <div id="page-registro" class="fade-in">
                 <div class="bg-white p-4 rounded-xl shadow-lg mb-8">
                    <div class="flex items-center gap-2 border-b-2 border-transparent focus-within:border-green-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                        <input type="text" id="search-input" placeholder="Buscar por nome da família..." class="w-full p-2 border-0 focus:ring-0">
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-semibold mb-6 border-b pb-3 text-gray-700">Novo Atendimento</h2>
                        <form id="form-atendimento" class="space-y-4">
                            <div><label for="nomeFamilia" class="block text-sm font-medium text-gray-600">Nome da Família</label><input name="nomeFamilia" type="text" id="nomeFamilia" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                            <div><label for="dataAtendimento" class="block text-sm font-medium text-gray-600">Data</label><input name="dataAtendimento" type="date" id="dataAtendimento" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                            <div><label for="tipoServico" class="block text-sm font-medium text-gray-600">Tipo de Serviço</label><select name="tipoServico" id="tipoServico" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"><option value="">Selecione...</option><option value="Acompanhamento Familiar">Acompanhamento Familiar</option><option value="Entrega de Cesta Básica">Entrega de Cesta Básica</option><option value="Orientação Jurídica">Orientação Jurídica</option><option value="Apoio Psicológico">Apoio Psicológico</option><option value="Cadastro Único">Cadastro Único</option><option value="Outro">Outro</option></select></div>
                            <div><label for="observacoes" class="block text-sm font-medium text-gray-600">Observações</label><textarea name="observacoes" id="observacoes" rows="4" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></textarea></div>
                            <button type="submit" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all shadow-md hover:shadow-lg">Salvar Atendimento</button>
                        </form>
                    </div>
                    <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-semibold mb-6 border-b pb-3 text-gray-700">Meus Atendimentos</h2>
                        <div id="lista-atendimentos" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </div>

            <!-- PÁGINA DE HISTÓRICO -->
            <div id="page-historico" class="fade-in hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-6 border-b pb-3 text-gray-700">Histórico de Atendimentos</h2>
                    <div class="mb-4 flex gap-4">
                        <input type="text" id="search-historico" placeholder="Buscar por nome da família..." class="flex-1 p-3 bg-gray-50 border rounded-md">
                        <select id="filter-profissional" class="p-3 bg-gray-50 border rounded-md">
                            <option value="">Todos os profissionais</option>
                        </select>
                    </div>
                    <div id="lista-historico-atendimentos" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2"></div>
                </div>
            </div>

            <!-- PÁGINA DO DASHBOARD GERENCIAL -->
            <div id="page-dashboard" class="fade-in hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold text-gray-700 mb-4">Evolução dos Atendimentos</h3><div id="chart-container-monthly" class="relative h-80"><canvas id="atendimentosPorMesChart"></canvas></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold text-gray-700 mb-4">Distribuição de Serviços</h3><div id="chart-container-services" class="relative h-80 flex justify-center items-center"><canvas id="atendimentosPorServicoChart"></canvas></div></div>
                 </div>
                 <div class="mt-8 bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Relatório Avançado de Atendimentos</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                        <div><label for="report-start-date" class="block text-sm font-medium text-gray-600">Data de Início</label><input type="date" id="report-start-date" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></div>
                        <div><label for="report-end-date" class="block text-sm font-medium text-gray-600">Data de Fim</label><input type="date" id="report-end-date" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></div>
                        <div><label for="report-service-filter" class="block text-sm font-medium text-gray-600">Filtrar por Serviço</label><select id="report-service-filter" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></select></div>
                        <div class="sm:col-span-3 text-right"><button id="export-excel-btn" class="w-full sm:w-auto bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all shadow-md">Exportar para Excel (.xlsx)</button></div>
                    </div>
                 </div>
            </div>

            <!-- PÁGINA DE ADMINISTRAÇÃO -->
            <div id="page-admin" class="fade-in hidden">
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-semibold mb-6 border-b pb-3 text-gray-700">Cadastrar Novo Usuário</h2>
                        <form id="add-user-form" class="space-y-4">
                            <div><label for="new-user-name" class="block text-sm font-medium text-gray-600">Nome do Profissional</label><input type="text" id="new-user-name" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border rounded-md"></div>
                            <div><label for="new-user-email" class="block text-sm font-medium text-gray-600">Email</label><input type="email" id="new-user-email" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border rounded-md"></div>
                            <div>
                                <label for="new-user-password" class="block text-sm font-medium text-gray-600">Senha Provisória</label>
                                <input type="password" id="new-user-password" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border rounded-md">
                                <div id="new-user-password-requirements" class="mt-2">
                                    <div class="password-requirement invalid" id="new-req-length">• Mínimo 8 caracteres</div>
                                    <div class="password-requirement invalid" id="new-req-uppercase">• Pelo menos 1 letra maiúscula</div>
                                    <div class="password-requirement invalid" id="new-req-lowercase">• Pelo menos 1 letra minúscula</div>
                                    <div class="password-requirement invalid" id="new-req-number">• Pelo menos 1 número</div>
                                    <div class="password-requirement invalid" id="new-req-special">• Pelo menos 1 caractere especial (!@#$%^&*)</div>
                                </div>
                            </div>
                            <div><label for="new-user-role" class="block text-sm font-medium text-gray-600">Função</label><select id="new-user-role" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border rounded-md"><option value="user">Assistente Social</option><option value="psychologist">Psicólogo</option><option value="technician">Nível Médio</option><option value="intern">Estagiário</option><option value="admin">Administrador</option></select></div>
                            <button type="submit" id="add-user-submit-btn" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700" disabled>Cadastrar Usuário</button>
                        </form>
                         <p id="admin-feedback" class="text-sm text-center mt-4 h-4"></p>
                    </div>
                    <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-semibold mb-6 border-b pb-3 text-gray-700">Usuários Cadastrados</h2>
                        <div id="users-list" class="space-y-3 max-h-[60vh] overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-10 pb-4 text-xs text-gray-500">
            <p>Usuário: <span id="user-email-display-footer" class="font-mono">N/A</span> | Versão 2.0</p>
        </footer>
    </div>
    
    <!-- MODAL DE EDIÇÃO -->
    <div id="edit-modal-backdrop" class="fixed inset-0 z-30 hidden items-center justify-center p-4">
        <div id="edit-modal" class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl transform transition-all -translate-y-10 opacity-0">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-700">Editar Atendimento</h2>
                <button id="close-modal-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="edit-nomeFamilia" class="block text-sm font-medium text-gray-600">Nome da Família</label><input type="text" id="edit-nomeFamilia" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border rounded-md"></div>
                    <div><label for="edit-dataAtendimento" class="block text-sm font-medium text-gray-600">Data</label><input type="date" id="edit-dataAtendimento" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border rounded-md"></div>
                </div>
                <div><label for="edit-tipoServico" class="block text-sm font-medium text-gray-600">Tipo de Serviço</label><select id="edit-tipoServico" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border rounded-md"><option value="Acompanhamento Familiar">Acompanhamento Familiar</option><option value="Entrega de Cesta Básica">Entrega de Cesta Básica</option><option value="Orientação Jurídica">Orientação Jurídica</option><option value="Apoio Psicológico">Apoio Psicológico</option><option value="Cadastro Único">Cadastro Único</option><option value="Outro">Outro</option></select></div>
                <div><label for="edit-observacoes" class="block text-sm font-medium text-gray-600">Observações</label><textarea id="edit-observacoes" rows="4" class="mt-1 block w-full px-3 py-2 bg-gray-50 border rounded-md"></textarea></div>
                
                <!-- Seção de Encaminhamento -->
                <div class="border-t pt-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Encaminhamento</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="edit-encaminhar-para" class="block text-sm font-medium text-gray-600">Encaminhar para</label>
                            <select id="edit-encaminhar-para" class="mt-1 block w-full px-3 py-2 bg-gray-50 border rounded-md">
                                <option value="">Não encaminhar</option>
                            </select>
                        </div>
                        <div>
                            <label for="edit-motivo-encaminhamento" class="block text-sm font-medium text-gray-600">Motivo do Encaminhamento</label>
                            <input type="text" id="edit-motivo-encaminhamento" class="mt-1 block w-full px-3 py-2 bg-gray-50 border rounded-md" placeholder="Ex: Necessita acompanhamento psicológico">
                        </div>
                    </div>
                </div>
                
                <!-- Histórico de Edições -->
                <div id="edit-history-container" class="border-t pt-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Histórico de Edições</h3>
                    <div id="edit-history-list"></div>
                </div>
                
                <div class="flex gap-4 pt-4">
                    <button type="button" id="cancel-edit-btn" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Encaminhamento -->
    <div id="referral-modal-backdrop" class="fixed inset-0 z-30 hidden items-center justify-center p-4">
        <div id="referral-modal" class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg transform transition-all -translate-y-10 opacity-0">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-700">Encaminhar Atendimento</h2>
                <button id="close-referral-modal-btn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="referral-form" class="space-y-4">
                <input type="hidden" id="referral-attendance-id">
                <div>
                    <label for="referral-to" class="block text-sm font-medium text-gray-600">Encaminhar para</label>
                    <select id="referral-to" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border rounded-md">
                        <option value="">Selecione um profissional</option>
                    </select>
                </div>
                <div>
                    <label for="referral-reason" class="block text-sm font-medium text-gray-600">Motivo do Encaminhamento</label>
                    <textarea id="referral-reason" rows="3" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border rounded-md" placeholder="Descreva o motivo do encaminhamento..."></textarea>
                </div>
                <div class="flex gap-4">
                    <button type="button" id="cancel-referral-btn" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700">Encaminhar</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, doc, deleteDoc, serverTimestamp, setDoc, getDoc, getDocs, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";
        
        // Configuração do Firebase
const firebaseConfig = {
  apiKey: "AIzaSyA23XFm_O2ZUJQU_BePuSYwBqv-2tEol08",
  authDomain: "sra-suas.firebaseapp.com",
  projectId: "sra-suas",
  storageBucket: "sra-suas.firebasestorage.app",
  messagingSenderId: "822160886742",
  appId: "1:822160886742:web:f7a4400e8e11e1fbabb277",
  measurementId: "G-5X706VZFZG"
};

        // Inicialização
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const functions = getFunctions(app, 'us-central1');
        
        // Estado Global
        let currentUser = null;
        let userProfile = null;
        let allAttendances = [];
        let allUsers = [];
        let unsubscribeAttendances = null;
        let unsubscribeUsers = null;
        let monthlyChart = null;
        let servicesChart = null;

        // --- Seletores de Elementos da UI ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authError = document.getElementById('auth-error');
        const showRegisterLink = document.getElementById('show-register-link');
        const showLoginLink = document.getElementById('show-login-link');
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const registerLinkContainer = document.getElementById('register-link-container');
        const mainNav = document.getElementById('main-nav');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailDisplayFooter = document.getElementById('user-email-display-footer');
        const userNameDisplay = document.getElementById('user-name-display');
        const searchInput = document.getElementById('search-input');
        const attendanceListContainer = document.getElementById('lista-atendimentos');
        const newAttendanceForm = document.getElementById('form-atendimento');
        const editModalBackdrop = document.getElementById('edit-modal-backdrop');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const addUserForm = document.getElementById('add-user-form');
        const usersListContainer = document.getElementById('users-list');
        const adminFeedback = document.getElementById('admin-feedback');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const dataAtendimentoInputForm = document.getElementById('dataAtendimento');
        
        // Novos elementos
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const forgotPasswordModalBackdrop = document.getElementById('forgot-password-modal-backdrop');
        const forgotPasswordModal = document.getElementById('forgot-password-modal');
        const forgotPasswordForm = document.getElementById('forgot-password-form');
        const closeForgotPasswordBtn = document.getElementById('close-forgot-password-btn');
        const cancelForgotPasswordBtn = document.getElementById('cancel-forgot-password-btn');
        const forgotPasswordFeedback = document.getElementById('forgot-password-feedback');
        
        const registerPassword = document.getElementById('register-password');
        const registerSubmitBtn = document.getElementById('register-submit-btn');
        const newUserPassword = document.getElementById('new-user-password');
        const addUserSubmitBtn = document.getElementById('add-user-submit-btn');
        
        const referralModalBackdrop = document.getElementById('referral-modal-backdrop');
        const referralModal = document.getElementById('referral-modal');
        const referralForm = document.getElementById('referral-form');
        const closeReferralModalBtn = document.getElementById('close-referral-modal-btn');
        const cancelReferralBtn = document.getElementById('cancel-referral-btn');

        // Funções de validação de senha
        function validatePassword(password) {
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*]/.test(password)
            };
            return requirements;
        }

        function updatePasswordRequirements(password, prefix = '') {
            const requirements = validatePassword(password);
            const reqElements = {
                length: document.getElementById(`${prefix}req-length`),
                uppercase: document.getElementById(`${prefix}req-uppercase`),
                lowercase: document.getElementById(`${prefix}req-lowercase`),
                number: document.getElementById(`${prefix}req-number`),
                special: document.getElementById(`${prefix}req-special`)
            };

            Object.keys(requirements).forEach(key => {
                const element = reqElements[key];
                if (element) {
                    element.className = `password-requirement ${requirements[key] ? 'valid' : 'invalid'}`;
                }
            });

            return Object.values(requirements).every(req => req);
        }

        // Event listeners para validação de senha
        registerPassword.addEventListener('input', (e) => {
            const isValid = updatePasswordRequirements(e.target.value);
            registerSubmitBtn.disabled = !isValid;
        });

        newUserPassword.addEventListener('input', (e) => {
            const isValid = updatePasswordRequirements(e.target.value, 'new-');
            addUserSubmitBtn.disabled = !isValid;
        });

        // --- Lógica de Autenticação ---
        
        showRegisterLink.addEventListener('click', (e) => { 
            e.preventDefault(); 
            loginView.classList.add('hidden'); 
            registerView.classList.remove('hidden'); 
        });
        
        showLoginLink.addEventListener('click', (e) => { 
            e.preventDefault(); 
            registerView.classList.add('hidden'); 
            loginView.classList.remove('hidden'); 
        });

        // Esqueci senha
        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            forgotPasswordModalBackdrop.classList.remove('hidden');
            forgotPasswordModalBackdrop.classList.add('flex');
            setTimeout(() => { forgotPasswordModal.classList.remove('-translate-y-10', 'opacity-0'); }, 10);
        });

        function closeForgotPasswordModal() {
            forgotPasswordModal.classList.add('-translate-y-10', 'opacity-0');
            setTimeout(() => { 
                forgotPasswordModalBackdrop.classList.add('hidden'); 
                forgotPasswordModalBackdrop.classList.remove('flex'); 
            }, 300);
        }

        closeForgotPasswordBtn.addEventListener('click', closeForgotPasswordModal);
        cancelForgotPasswordBtn.addEventListener('click', closeForgotPasswordModal);
        forgotPasswordModalBackdrop.addEventListener('click', (e) => { 
            if (e.target === forgotPasswordModalBackdrop) closeForgotPasswordModal(); 
        });

        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = forgotPasswordForm['forgot-email'].value;
            
            try {
                await sendPasswordResetEmail(auth, email);
                forgotPasswordFeedback.textContent = 'Link de recuperação enviado para seu email!';
                forgotPasswordFeedback.className = 'text-green-600 text-sm text-center mt-4 h-4';
                setTimeout(() => {
                    closeForgotPasswordModal();
                    forgotPasswordForm.reset();
                    forgotPasswordFeedback.textContent = '';
                }, 3000);
            } catch (error) {
                forgotPasswordFeedback.textContent = 'Erro ao enviar email. Verifique o endereço.';
                forgotPasswordFeedback.className = 'text-red-500 text-sm text-center mt-4 h-4';
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            authError.textContent = '';
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => { 
                    authError.textContent = "Email ou senha inválidos."; 
                    console.error("Erro de login:", error.message); 
                });
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.textContent = '';
            const name = registerForm['register-name'].value;
            const email = registerForm['register-email'].value;
            const password = registerForm['register-password'].value;
            
            // Verificar se já existe um administrador
            const usersQuery = query(collection(db, "users"), where("role", "==", "admin"));
            const adminSnapshot = await getDocs(usersQuery);

            if (!adminSnapshot.empty) {
                authError.textContent = "O registro de administrador já foi feito.";
                return;
            }

            // Validar senha
            if (!updatePasswordRequirements(password)) {
                authError.textContent = "A senha não atende aos requisitos de segurança.";
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await setDoc(doc(db, "users", user.uid), { 
                    name, 
                    email, 
                    role: 'admin', 
                    createdAt: serverTimestamp(),
                    needsPasswordChange: false
                });
            } catch (error) {
                authError.textContent = "Erro ao cadastrar. Verifique os dados."; 
                console.error("Erro de registro:", error.message);
            }
        });
        
        logoutBtn.addEventListener('click', () => { signOut(auth); });

        // Verificar se deve mostrar o link de cadastro
        async function checkShowRegisterLink() {
            try {
                const usersQuery = query(collection(db, "users"), where("role", "==", "admin"));
                const adminSnapshot = await getDocs(usersQuery);
                
                if (!adminSnapshot.empty) {
                    registerLinkContainer.style.display = 'none';
                } else {
                    registerLinkContainer.style.display = 'block';
                }
            } catch (error) {
                console.error("Erro ao verificar administradores:", error);
                registerLinkContainer.style.display = 'block';
            }
        }

        // Verificar ao carregar a página
        checkShowRegisterLink();

        // --- Listener de Autenticação Principal ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await fetchUserProfile(user.uid);
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                userEmailDisplayFooter.textContent = user.email;
                userNameDisplay.textContent = userProfile?.name || 'N/A';
                setupNavigation();
                listenForAttendances();
                listenForUsers();
            } else {
                currentUser = null;
                userProfile = null;
                if (unsubscribeAttendances) unsubscribeAttendances();
                if (unsubscribeUsers) unsubscribeUsers();
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                checkShowRegisterLink();
            }
        });
        
        // --- Funções de Perfil e Navegação ---
        async function fetchUserProfile(uid) {
            const userDocRef = doc(db, "users", uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                userProfile = { id: userDoc.id, ...userDoc.data() };
                const tokenResult = await currentUser.getIdTokenResult(true);
                userProfile.role = tokenResult.claims.role || userProfile.role;
            } else {
                userProfile = null;
            }
        }

        function setupNavigation() {
            mainNav.innerHTML = '';
            const pages = { 
                'page-registro': 'Registro', 
                'page-historico': 'Histórico',
                'page-dashboard': 'Dashboard', 
                'page-admin': 'Administração' 
            };
            const rolesVisibility = {
                'page-registro': ['admin', 'user', 'psychologist', 'technician', 'intern'],
                'page-historico': ['admin', 'user', 'psychologist', 'technician', 'intern'],
                'page-dashboard': ['admin', 'user', 'psychologist', 'technician', 'intern'],
                'page-admin': ['admin']
            };
            const visiblePages = Object.keys(pages).filter(pageId => rolesVisibility[pageId].includes(userProfile?.role));
            
            visiblePages.forEach((pageId) => {
                const button = document.createElement('button');
                button.textContent = pages[pageId];
                button.className = 'nav-button px-4 py-1.5 text-sm font-semibold rounded-md';
                button.addEventListener('click', () => {
                    mainNav.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    Object.keys(pages).forEach(pId => document.getElementById(pId)?.classList.add('hidden'));
                    document.getElementById(pageId).classList.remove('hidden');
                });
                mainNav.appendChild(button);
            });
            
            const firstButton = mainNav.querySelector('button');
            if (firstButton) {
                firstButton.classList.add('active');
                const firstPageId = visiblePages[0];
                Object.keys(pages).forEach(pId => document.getElementById(pId)?.classList.add('hidden'));
                document.getElementById(firstPageId).classList.remove('hidden');
            }
        }

        // --- Lógica de Atendimentos (CRUD + Busca) ---
        function listenForAttendances() {
            if (unsubscribeAttendances) unsubscribeAttendances();
            
            let q;
            if (userProfile?.role === 'admin') {
                // Admin vê todos os atendimentos
                q = query(collection(db, "atendimentos"), orderBy("dataAtendimento", "desc"));
            } else {
                // Outros usuários veem apenas seus próprios atendimentos e encaminhamentos
                q = query(
                    collection(db, "atendimentos"), 
                    where("autorId", "==", currentUser.uid),
                    orderBy("dataAtendimento", "desc")
                );
            }
            
            unsubscribeAttendances = onSnapshot(q, snapshot => {
                allAttendances = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderAttendanceList(allAttendances);
                renderHistoricoList(allAttendances);
                updateDashboard(allAttendances);
            });
        }

        function listenForUsers() {
            if (unsubscribeUsers) unsubscribeUsers();
            const q = query(collection(db, "users"), orderBy("name"));
            unsubscribeUsers = onSnapshot(q, snapshot => {
                allUsers = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderUsersList(allUsers);
                updateReferralOptions();
                updateHistoricoFilter();
            });
        }

        function updateReferralOptions() {
            const referralSelect = document.getElementById('referral-to');
            const editReferralSelect = document.getElementById('edit-encaminhar-para');
            
            [referralSelect, editReferralSelect].forEach(select => {
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = select.id === 'edit-encaminhar-para' ? 
                        '<option value="">Não encaminhar</option>' : 
                        '<option value="">Selecione um profissional</option>';
                    
                    allUsers.filter(user => user.id !== currentUser.uid).forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = `${user.name} (${getRoleDisplayName(user.role)})`;
                        select.appendChild(option);
                    });
                    
                    select.value = currentValue;
                }
            });
        }

        function updateHistoricoFilter() {
            const filterSelect = document.getElementById('filter-profissional');
            if (filterSelect) {
                const currentValue = filterSelect.value;
                filterSelect.innerHTML = '<option value="">Todos os profissionais</option>';
                
                allUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.name} (${getRoleDisplayName(user.role)})`;
                    filterSelect.appendChild(option);
                });
                
                filterSelect.value = currentValue;
            }
        }

        function getRoleDisplayName(role) {
            const roleNames = {
                'admin': 'Administrador',
                'user': 'Assistente Social',
                'psychologist': 'Psicólogo',
                'technician': 'Nível Médio',
                'intern': 'Estagiário'
            };
            return roleNames[role] || role;
        }
        
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredAttendances = allAttendances.filter(at => 
                at.nomeFamilia.toLowerCase().includes(searchTerm)
            );
            renderAttendanceList(filteredAttendances);
        });

        // Busca no histórico
        const searchHistorico = document.getElementById('search-historico');
        const filterProfissional = document.getElementById('filter-profissional');
        
        function filterHistorico() {
            const searchTerm = searchHistorico.value.toLowerCase();
            const selectedProfissional = filterProfissional.value;
            
            let filteredAttendances = allAttendances;
            
            if (searchTerm) {
                filteredAttendances = filteredAttendances.filter(at => 
                    at.nomeFamilia.toLowerCase().includes(searchTerm)
                );
            }
            
            if (selectedProfissional) {
                filteredAttendances = filteredAttendances.filter(at => 
                    at.autorId === selectedProfissional
                );
            }
            
            renderHistoricoList(filteredAttendances);
        }

        searchHistorico.addEventListener('input', filterHistorico);
        filterProfissional.addEventListener('change', filterHistorico);

        function renderAttendanceList(attendances) {
            attendanceListContainer.innerHTML = '';
            if (attendances.length === 0) {
                attendanceListContainer.innerHTML = `<div class="text-center text-gray-500 p-8 border-2 border-dashed rounded-lg">Nenhum atendimento encontrado.</div>`;
                return;
            }
            
            // Filtrar apenas os atendimentos do usuário atual (exceto admin)
            const userAttendances = userProfile?.role === 'admin' ? attendances : 
                attendances.filter(at => at.autorId === currentUser.uid);
            
            userAttendances.forEach(at => {
                if (!at.dataAtendimento || typeof at.dataAtendimento.toDate !== 'function') return;
                const dataFormatada = at.dataAtendimento.toDate().toLocaleDateString('pt-BR');
                const autorName = allUsers.find(user => user.id === at.autorId)?.name || at.autorEmail;
                
                const div = document.createElement('div');
                div.className = 'p-4 border rounded-xl shadow-sm bg-gray-50 hover:shadow-md transition-all duration-300 cursor-pointer';
                div.innerHTML = `
                    <div>
                        <p class="font-bold text-lg text-green-800">${at.nomeFamilia}</p>
                        <p class="text-sm text-gray-600"><span class="font-semibold text-gray-700">Serviço:</span> ${at.tipoServico}</p>
                        <p class="text-sm text-gray-600"><span class="font-semibold text-gray-700">Data:</span> ${dataFormatada}</p>
                        <p class="text-sm text-gray-600"><span class="font-semibold text-gray-700">Profissional:</span> ${autorName}</p>
                        ${at.encaminhamentos && at.encaminhamentos.length > 0 ? 
                            `<p class="text-sm text-blue-600 font-medium">• Possui encaminhamentos</p>` : ''}
                    </div>
                `;
                div.addEventListener('click', () => openEditModal(at));
                attendanceListContainer.appendChild(div);
            });
        }

        function renderHistoricoList(attendances) {
            const historicoContainer = document.getElementById('lista-historico-atendimentos');
            if (!historicoContainer) return;
            
            historicoContainer.innerHTML = '';
            if (attendances.length === 0) {
                historicoContainer.innerHTML = `<div class="text-center text-gray-500 p-8 border-2 border-dashed rounded-lg">Nenhum atendimento encontrado.</div>`;
                return;
            }
            
            attendances.forEach(at => {
                if (!at.dataAtendimento || typeof at.dataAtendimento.toDate !== 'function') return;
                const dataFormatada = at.dataAtendimento.toDate().toLocaleDateString('pt-BR');
                const autorName = allUsers.find(user => user.id === at.autorId)?.name || at.autorEmail;
                
                const div = document.createElement('div');
                div.className = 'p-4 border rounded-xl shadow-sm bg-gray-50 hover:shadow-md transition-all duration-300';
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <p class="font-bold text-lg text-green-800">${at.nomeFamilia}</p>
                            <p class="text-sm text-gray-600"><span class="font-semibold text-gray-700">Serviço:</span> ${at.tipoServico}</p>
                            <p class="text-sm text-gray-600"><span class="font-semibold text-gray-700">Data:</span> ${dataFormatada}</p>
                            <p class="text-sm text-gray-600"><span class="font-semibold text-gray-700">Profissional:</span> ${autorName}</p>
                            ${at.observacoes ? `<p class="text-sm text-gray-600 mt-2"><span class="font-semibold text-gray-700">Observações:</span> ${at.observacoes}</p>` : ''}
                            ${at.encaminhamentos && at.encaminhamentos.length > 0 ? 
                                `<div class="mt-2">
                                    <p class="text-sm font-semibold text-blue-700">Encaminhamentos:</p>
                                    ${at.encaminhamentos.map(enc => {
                                        const encProfissional = allUsers.find(user => user.id === enc.paraId)?.name || 'Profissional não encontrado';
                                        return `<p class="text-sm text-blue-600">• Para: ${encProfissional} - ${enc.motivo}</p>`;
                                    }).join('')}
                                </div>` : ''}
                            ${at.editHistory && at.editHistory.length > 0 ? 
                                `<div class="mt-2">
                                    <p class="text-sm font-semibold text-gray-700">Histórico de edições: ${at.editHistory.length}</p>
                                </div>` : ''}
                        </div>
                        <div class="flex gap-2 ml-4">
                            ${(userProfile?.role === 'admin' || at.autorId === currentUser.uid) ? 
                                `<button onclick="openEditModal('${at.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">Editar</button>` : ''}
                            ${userProfile?.role !== 'admin' && at.autorId !== currentUser.uid ? 
                                `<button onclick="openReferralModal('${at.id}')" class="text-green-600 hover:text-green-800 text-sm font-semibold">Encaminhar</button>` : ''}
                        </div>
                    </div>
                `;
                historicoContainer.appendChild(div);
            });
        }
        
        newAttendanceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            await addDoc(collection(db, "atendimentos"), {
                ...data,
                dataAtendimento: new Date(data.dataAtendimento + 'T00:00:00-03:00'),
                criadoEm: serverTimestamp(),
                autorId: currentUser.uid,
                autorEmail: currentUser.email,
                autorName: userProfile?.name || currentUser.email,
                editHistory: [],
                encaminhamentos: []
            });
            e.target.reset();
            dataAtendimentoInputForm.valueAsDate = new Date();
        });
        
        function openEditModal(atendimento) {
            if (typeof atendimento === 'string') {
                atendimento = allAttendances.find(at => at.id === atendimento);
            }
            if (!atendimento) return;
            
            editForm.reset();
            editForm['edit-id'].value = atendimento.id;
            editForm['edit-nomeFamilia'].value = atendimento.nomeFamilia;
            editForm['edit-dataAtendimento'].value = atendimento.dataAtendimento.toDate().toISOString().split('T')[0];
            editForm['edit-tipoServico'].value = atendimento.tipoServico;
            editForm['edit-observacoes'].value = atendimento.observacoes || '';
            
            // Renderizar histórico de edições
            renderEditHistory(atendimento.editHistory || []);
            
            editModalBackdrop.classList.remove('hidden');
            editModalBackdrop.classList.add('flex');
            setTimeout(() => { editModal.classList.remove('-translate-y-10', 'opacity-0'); }, 10);
        }

        function renderEditHistory(editHistory) {
            const historyContainer = document.getElementById('edit-history-list');
            historyContainer.innerHTML = '';
            
            if (editHistory.length === 0) {
                historyContainer.innerHTML = '<p class="text-sm text-gray-500">Nenhuma edição registrada.</p>';
                return;
            }
            
            editHistory.forEach(edit => {
                const div = document.createElement('div');
                div.className = 'edit-history';
                const editDate = edit.timestamp?.toDate ? edit.timestamp.toDate().toLocaleString('pt-BR') : 'Data não disponível';
                const editorName = allUsers.find(user => user.id === edit.editorId)?.name || edit.editorEmail || 'Editor desconhecido';
                
                div.innerHTML = `
                    <div class="edit-history-item">
                        <strong>${editDate}</strong> - Editado por: ${editorName}
                    </div>
                    ${edit.changes ? `<div class="edit-history-item">Alterações: ${edit.changes}</div>` : ''}
                `;
                historyContainer.appendChild(div);
            });
        }

        function closeEditModal() {
            editModal.classList.add('-translate-y-10', 'opacity-0');
            setTimeout(() => { 
                editModalBackdrop.classList.add('hidden'); 
                editModalBackdrop.classList.remove('flex'); 
            }, 300);
        }

        closeModalBtn.addEventListener('click', closeEditModal);
        cancelEditBtn.addEventListener('click', closeEditModal);
        editModalBackdrop.addEventListener('click', (e) => { 
            if (e.target === editModalBackdrop) closeEditModal(); 
        });

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = editForm['edit-id'].value;
            const originalAttendance = allAttendances.find(at => at.id === id);
            
            const updateData = {
                nomeFamilia: editForm['edit-nomeFamilia'].value,
                dataAtendimento: new Date(editForm['edit-dataAtendimento'].value + 'T00:00:00-03:00'),
                tipoServico: editForm['edit-tipoServico'].value,
                observacoes: editForm['edit-observacoes'].value,
            };
            
            // Detectar mudanças
            const changes = [];
            if (originalAttendance.nomeFamilia !== updateData.nomeFamilia) {
                changes.push(`Nome da família: "${originalAttendance.nomeFamilia}" → "${updateData.nomeFamilia}"`);
            }
            if (originalAttendance.tipoServico !== updateData.tipoServico) {
                changes.push(`Tipo de serviço: "${originalAttendance.tipoServico}" → "${updateData.tipoServico}"`);
            }
            if ((originalAttendance.observacoes || '') !== updateData.observacoes) {
                changes.push(`Observações alteradas`);
            }
            
            // Processar encaminhamento
            const encaminharPara = editForm['edit-encaminhar-para'].value;
            const motivoEncaminhamento = editForm['edit-motivo-encaminhamento'].value;
            
            if (encaminharPara && motivoEncaminhamento) {
                const novoEncaminhamento = {
                    paraId: encaminharPara,
                    motivo: motivoEncaminhamento,
                    timestamp: serverTimestamp(),
                    deId: currentUser.uid,
                    deNome: userProfile?.name || currentUser.email
                };
                
                updateData.encaminhamentos = arrayUnion(novoEncaminhamento);
                changes.push(`Encaminhado para: ${allUsers.find(u => u.id === encaminharPara)?.name}`);
            }
            
            // Adicionar ao histórico de edições se houve mudanças
            if (changes.length > 0) {
                const editEntry = {
                    timestamp: serverTimestamp(),
                    editorId: currentUser.uid,
                    editorEmail: currentUser.email,
                    editorName: userProfile?.name || currentUser.email,
                    changes: changes.join('; ')
                };
                
                updateData.editHistory = arrayUnion(editEntry);
            }
            
            await updateDoc(doc(db, "atendimentos", id), updateData);
            closeEditModal();
        });

        // Modal de Encaminhamento
        function openReferralModal(attendanceId) {
            document.getElementById('referral-attendance-id').value = attendanceId;
            referralModalBackdrop.classList.remove('hidden');
            referralModalBackdrop.classList.add('flex');
            setTimeout(() => { referralModal.classList.remove('-translate-y-10', 'opacity-0'); }, 10);
        }

        function closeReferralModal() {
            referralModal.classList.add('-translate-y-10', 'opacity-0');
            setTimeout(() => { 
                referralModalBackdrop.classList.add('hidden'); 
                referralModalBackdrop.classList.remove('flex'); 
            }, 300);
        }

        closeReferralModalBtn.addEventListener('click', closeReferralModal);
        cancelReferralBtn.addEventListener('click', closeReferralModal);
        referralModalBackdrop.addEventListener('click', (e) => { 
            if (e.target === referralModalBackdrop) closeReferralModal(); 
        });

        referralForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const attendanceId = document.getElementById('referral-attendance-id').value;
            const referralTo = document.getElementById('referral-to').value;
            const referralReason = document.getElementById('referral-reason').value;
            
            const novoEncaminhamento = {
                paraId: referralTo,
                motivo: referralReason,
                timestamp: serverTimestamp(),
                deId: currentUser.uid,
                deNome: userProfile?.name || currentUser.email
            };
            
            const editEntry = {
                timestamp: serverTimestamp(),
                editorId: currentUser.uid,
                editorEmail: currentUser.email,
                editorName: userProfile?.name || currentUser.email,
                changes: `Encaminhado para: ${allUsers.find(u => u.id === referralTo)?.name}`
            };
            
            await updateDoc(doc(db, "atendimentos", attendanceId), {
                encaminhamentos: arrayUnion(novoEncaminhamento),
                editHistory: arrayUnion(editEntry)
            });
            
            referralForm.reset();
            closeReferralModal();
        });

        // Tornar funções globais para uso nos botões
        window.openEditModal = openEditModal;
        window.openReferralModal = openReferralModal;

        // --- Lógica da Página de Administração ---
        function renderUsersList(users) {
            usersListContainer.innerHTML = '';
            users.forEach(user => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${user.name}</p>
                        <p class="text-sm text-gray-500">${user.email} - <span class="capitalize font-medium">${getRoleDisplayName(user.role)}</span></p>
                    </div>
                    ${user.id !== currentUser.uid ? 
                        `<button data-id="${user.id}" class="btn-delete-user text-red-500 hover:text-red-700 text-xs font-semibold">REMOVER</button>` : 
                        ''}
                `;
                usersListContainer.appendChild(div);
            });
        }

        addUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = addUserForm.querySelector('button');
            btn.disabled = true;
            adminFeedback.textContent = 'Processando...';
            adminFeedback.className = 'text-blue-600 text-sm text-center mt-4 h-4';
            
            const name = addUserForm['new-user-name'].value;
            const email = addUserForm['new-user-email'].value;
            const password = addUserForm['new-user-password'].value;
            const role = addUserForm['new-user-role'].value;

            // Validar senha
            if (!updatePasswordRequirements(password, 'new-')) {
                adminFeedback.textContent = 'A senha não atende aos requisitos de segurança.';
                adminFeedback.className = 'text-red-500 text-sm text-center mt-4 h-4';
                btn.disabled = false;
                return;
            }

            const createNewUser = httpsCallable(functions, 'createNewUser');
            
            try {
                const result = await createNewUser({ name, email, password, role });
                adminFeedback.textContent = result.data.result;
                adminFeedback.className = 'text-green-600 text-sm text-center mt-4 h-4';
                addUserForm.reset();
                // Resetar validação de senha
                updatePasswordRequirements('', 'new-');
                addUserSubmitBtn.disabled = true;
            } catch (error) {
                console.error("Erro ao chamar Cloud Function:", error);
                adminFeedback.textContent = error.message;
                adminFeedback.className = 'text-red-500 text-sm text-center mt-4 h-4';
            } finally {
                btn.disabled = false;
            }
        });
        
        // --- Lógica de Dashboard e Relatórios ---
        function updateDashboard(attendances) {
            const serviceFilter = document.getElementById('report-service-filter');
            if (!serviceFilter) return;
            
            const services = [...new Set(attendances.map(at => at.tipoServico))].sort();
            const currentFilterValue = serviceFilter.value;
            serviceFilter.innerHTML = '<option value="todos">Todos os Serviços</option>';
            services.forEach(s => {
                const option = document.createElement('option');
                option.value = s; 
                option.textContent = s; 
                serviceFilter.appendChild(option);
            });
            serviceFilter.value = currentFilterValue;
            updateAllCharts(attendances);
        }
        
        function updateAllCharts(attendances) {
            const monthlyCtx = document.getElementById('atendimentosPorMesChart')?.getContext('2d');
            const servicesCtx = document.getElementById('atendimentosPorServicoChart')?.getContext('2d');
            
            if (!monthlyCtx || !servicesCtx) return;
            
            if (attendances.length === 0) {
                showChartMessage(monthlyCtx.canvas.parentElement, 'Sem dados para exibir.');
                showChartMessage(servicesCtx.canvas.parentElement, 'Sem dados para exibir.');
                return;
            }
            
            hideChartMessage(monthlyCtx.canvas.parentElement);
            hideChartMessage(servicesCtx.canvas.parentElement);

            const monthlyData = attendances.reduce((acc, curr) => {
                if (!curr.dataAtendimento?.toDate) return acc;
                const date = curr.dataAtendimento.toDate();
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!acc[key]) acc[key] = { count: 0, label: date.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' }) };
                acc[key].count++;
                return acc;
            }, {});

            const servicesData = attendances.reduce((acc, curr) => {
                acc[curr.tipoServico] = (acc[curr.tipoServico] || 0) + 1;
                return acc;
            }, {});

            // Gráfico mensal
            if (monthlyChart) monthlyChart.destroy();
            monthlyChart = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: Object.values(monthlyData).map(d => d.label),
                    datasets: [{
                        label: 'Atendimentos por Mês',
                        data: Object.values(monthlyData).map(d => d.count),
                        borderColor: '#16a34a',
                        backgroundColor: 'rgba(22, 163, 74, 0.1)',
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Gráfico de serviços
            if (servicesChart) servicesChart.destroy();
            servicesChart = new Chart(servicesCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(servicesData),
                    datasets: [{
                        data: Object.values(servicesData),
                        backgroundColor: ['#16a34a', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function showChartMessage(container, message) {
            container.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500">${message}</div>`;
        }

        function hideChartMessage(container) {
            const canvas = container.querySelector('canvas');
            if (canvas) canvas.style.display = 'block';
        }

        // Exportar para Excel
        if (exportExcelBtn) {
            exportExcelBtn.addEventListener('click', () => {
                const startDate = document.getElementById('report-start-date').value;
                const endDate = document.getElementById('report-end-date').value;
                const serviceFilter = document.getElementById('report-service-filter').value;
                
                let filteredData = allAttendances;
                
                if (startDate) {
                    filteredData = filteredData.filter(at => 
                        at.dataAtendimento.toDate() >= new Date(startDate)
                    );
                }
                
                if (endDate) {
                    filteredData = filteredData.filter(at => 
                        at.dataAtendimento.toDate() <= new Date(endDate)
                    );
                }
                
                if (serviceFilter && serviceFilter !== 'todos') {
                    filteredData = filteredData.filter(at => at.tipoServico === serviceFilter);
                }
                
                const excelData = filteredData.map(at => ({
                    'Nome da Família': at.nomeFamilia,
                    'Data': at.dataAtendimento.toDate().toLocaleDateString('pt-BR'),
                    'Tipo de Serviço': at.tipoServico,
                    'Observações': at.observacoes || '',
                    'Profissional': allUsers.find(user => user.id === at.autorId)?.name || at.autorEmail,
                    'Encaminhamentos': at.encaminhamentos?.length || 0,
                    'Edições': at.editHistory?.length || 0
                }));
                
                const ws = XLSX.utils.json_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Atendimentos");
                XLSX.writeFile(wb, `atendimentos_${new Date().toISOString().split('T')[0]}.xlsx`);
            });
        }

        // Definir data atual no formulário
        if (dataAtendimentoInputForm) {
            dataAtendimentoInputForm.valueAsDate = new Date();
        }
    </script>

</body>
</html>

